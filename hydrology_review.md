

# Hydrology System Review (`hydrology.py` vs. `river-generator.js`)

**Conclusion:** Needs significant revision. While the high-level process is the same, the implementation of the most critical algorithm, depression filling, is incorrect. This will have a major impact on the final output.

| Feature                                                    | Finding/Observation                                                                                                                                                             | Analysis                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| :--------------------------------------------------------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | :-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Altering Heights (`alter_heights`)**                     | **DISCREPANCY:** The Python `alter_heights` function uses a different method to break ties in flat areas than the JavaScript version.                                           | **JS (`alterHeights`):** `h + t[i] / 100 + d3.mean(c[i].map(c => t[c])) / 10000;`. This adds a small, *deterministic* height value based on the cell's distance to water (`t[i]`).<br><br>**Python (`alter_heights`):** `self.graph.heights[i] += (hash(i) % 21 - 10) * 0.00001`. This adds a pseudo-random value based on the cell's index. <br><br>This change breaks the determinism based on map features and will lead to different water flow paths in flat areas.                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| **Depression Filling (`resolve_depressions`)**             | **CRITICAL ISSUE:** The `resolve_depressions` function in Python is **not a faithful port** of the JavaScript original. It is a much simpler and logically different algorithm. | **JS (`resolveDepressions`):** This is a sophisticated iterative algorithm. It processes cells from lowest to highest. If a cell `i` is lower than its lowest neighbor (`minHeight`), it's raised to `minHeight + 0.1`. It also contains complex logic for handling lakes (`l.closed`, `l.height`) to prevent them from being filled incorrectly.<br><br>**Python (`resolve_depressions`):** This implementation seems to check if a cell is lower than *all* its neighbors (`_is_depressed`) and then raises it. This is a fundamentally different check. It also completely lacks the special handling for lake features that is present in the JS version. <br><br>**Impact:** This incorrect algorithm will fail to resolve many complex depressions and will produce a river network that does not match the original generator's output. **This is the single most important issue to fix in the entire port.** |
| **Water Drainage (`drain_water`, `_flow_water_downhill`)** | The high-level logic for draining water is correct. It correctly sorts land cells from highest to lowest and processes them.                                                    | This part of the process seems well-understood. The core idea of accumulating precipitation flux and flowing it downhill is preserved.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| **River Confluence (`_flow_down`)**                        | The logic for handling river confluences by comparing the flux of the merging rivers appears to be a good translation of the JS `flowDown` function.                            | **JS (`flowDown`):** It uses a `riverParents` object to track which river becomes a tributary. `if (fromFlux > toFlux) { riverParents[toRiver] = river; ... }`.<br><br>**Python (`_flow_down`):** It correctly compares fluxes and sets the `parent_id` on the `RiverData` object, which is a good equivalent. `if from_flux > to_flux: self.rivers[to_river_id].parent_id = river_id`. This part of the water flow simulation seems correct.                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |

### **Recommendations**

1.  **Prioritize Fixing `hydrology.py`:** This module requires the most attention.
    *   **Rewrite `resolve_depressions`:** This function must be rewritten to be a 1:1 logical port of the `resolveDepressions` function in `river-generator.js`. Pay close attention to how it iterates through sorted cells and how it handles lake features (`pack.features`). This is a non-trivial task but is essential for correctness.
    *   **Correct `alter_heights`:** To ensure identical output, this function should be modified to use the distance-to-water metric (`pack.cells.t` in JS) for tie-breaking, rather than a hash-based random value. This will require ensuring that the distance-to-water data is calculated and available at this stage.

2.  **Verify Data Dependencies:** The `hydrology` discrepancies highlight a common challenge in porting: ensuring all necessary data from previous steps is available. For `alter_heights`, you'll need the equivalent of `pack.cells.t`. For `resolve_depressions`, you'll need the lake feature data from `pack.features`. Ensure your Python `graph` and `features` objects contain all the required attributes from the JS `pack` object.
