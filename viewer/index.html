<!DOCTYPE html>
<html lang="en">
<head>
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.95/Build/Cesium/Cesium.js"></script>
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.95/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
    <style>
        html, body, #cesiumContainer {
            width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden;
        }
        #toolbar {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(42, 42, 42, 0.8);
            padding: 10px;
            border-radius: 5px;
            color: white;
            font-family: Arial, sans-serif;
        }
        #toolbar button {
            margin: 5px;
            padding: 5px 10px;
            background: #48b;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        #toolbar button:hover {
            background: #369;
        }
        #toolbar button.active {
            background: #5a5;
        }
        #info {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(42, 42, 42, 0.8);
            padding: 10px;
            border-radius: 5px;
            color: white;
            font-family: Arial, sans-serif;
            max-width: 300px;
        }
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(42, 42, 42, 0.9);
            padding: 20px;
            border-radius: 10px;
            color: white;
            font-family: Arial, sans-serif;
            text-align: center;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div id="cesiumContainer"></div>
    <div id="loading">
        <h3>Loading 3D Map...</h3>
        <p id="loadingStatus">Initializing viewer...</p>
    </div>
    <div id="toolbar" class="hidden">
        <h4 id="mapTitle">Fantasy Map 3D</h4>
        <button id="terrainBtn" onclick="toggleLayer('terrain')">Terrain</button>
        <button id="settlementsBtn" onclick="toggleLayer('settlements')">Settlements</button>
        <button id="riversBtn" onclick="toggleLayer('rivers')">Rivers</button>
        <button id="culturesBtn" onclick="toggleLayer('cultures')">Cultures</button>
        <button id="statesBtn" onclick="toggleLayer('states')">States</button>
        <br>
        <button onclick="showAll()">Show All</button>
        <button onclick="hideAll()">Hide All</button>
        <button onclick="resetView()">Reset View</button>
        <button onclick="toggleInfo()">Info</button>
    </div>
    <div id="info" class="hidden">
        <h4>Map Information</h4>
        <p><strong>Map ID:</strong> <span id="mapId">-</span></p>
        <p><strong>Layers:</strong> <span id="layerCount">0</span></p>
        <p><strong>Total Features:</strong> <span id="featureCount">0</span></p>
        <p><strong>Last Updated:</strong> <span id="lastUpdated">-</span></p>
    </div>

    <script>
        // Parse URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const mapId = urlParams.get('map') || 'latest';
        const enabledLayers = urlParams.get('layers') ? urlParams.get('layers').split(',') : ['terrain'];
        const terrainExaggeration = parseFloat(urlParams.get('exaggeration')) || 1.0;

        // Initialize Cesium viewer
        const viewer = new Cesium.Viewer('cesiumContainer', {
            terrainProvider: Cesium.createWorldTerrain(),
            homeButton: false,
            sceneModePicker: false,
            baseLayerPicker: false,
            navigationHelpButton: false,
            animation: false,
            timeline: false,
            fullscreenButton: false,
            geocoder: false
        });

        // Store tilesets and their status
        let tilesets = {};
        let layerStatus = {};
        let mapInfo = {};

        // Update loading status
        function updateLoadingStatus(message) {
            document.getElementById('loadingStatus').textContent = message;
        }

        // Load map information
        async function loadMapInfo() {
            try {
                updateLoadingStatus('Loading map information...');
                const response = await fetch(`/maps/${mapId}/visualize/info`);
                if (response.ok) {
                    mapInfo = await response.json();
                    document.getElementById('mapTitle').textContent = mapInfo.map_name || 'Fantasy Map 3D';
                    document.getElementById('mapId').textContent = mapInfo.map_id;
                    document.getElementById('layerCount').textContent = mapInfo.layers.length;
                    document.getElementById('lastUpdated').textContent = mapInfo.last_generated || 'Never';
                    
                    // Update layer status
                    mapInfo.layers.forEach(layer => {
                        layerStatus[layer.layer] = layer;
                    });
                    
                    return true;
                } else {
                    console.error('Failed to load map info:', response.statusText);
                    return false;
                }
            } catch (error) {
                console.error('Error loading map info:', error);
                return false;
            }
        }

        // Load 3D tileset
        function loadTileset(name, url) {
            return new Promise((resolve, reject) => {
                try {
                    updateLoadingStatus(`Loading ${name} layer...`);
                    
                    const tileset = viewer.scene.primitives.add(
                        new Cesium.Cesium3DTileset({
                            url: url,
                            show: enabledLayers.includes(name)
                        })
                    );
                    
                    tileset.readyPromise.then(function(tileset) {
                        console.log(`${name} tileset loaded successfully`);
                        
                        // Apply terrain exaggeration if this is terrain
                        if (name === 'terrain' && terrainExaggeration !== 1.0) {
                            const heightOffset = 0;
                            const cartographic = Cesium.Cartographic.fromCartesian(tileset.boundingSphere.center);
                            const surface = Cesium.Cartesian3.fromRadians(
                                cartographic.longitude, 
                                cartographic.latitude, 
                                cartographic.height * terrainExaggeration + heightOffset
                            );
                            const translation = Cesium.Cartesian3.subtract(surface, tileset.boundingSphere.center, new Cesium.Cartesian3());
                            tileset.modelMatrix = Cesium.Matrix4.fromTranslation(translation);
                        }
                        
                        // Update button state
                        const button = document.getElementById(`${name}Btn`);
                        if (button) {
                            button.disabled = false;
                            if (enabledLayers.includes(name)) {
                                button.classList.add('active');
                            }
                        }
                        
                        resolve(tileset);
                    }).otherwise(function(error) {
                        console.error(`Error loading ${name} tileset:`, error);
                        
                        // Disable button if tileset failed to load
                        const button = document.getElementById(`${name}Btn`);
                        if (button) {
                            button.disabled = true;
                            button.textContent = `${name} (unavailable)`;
                        }
                        
                        reject(error);
                    });
                    
                    tilesets[name] = tileset;
                } catch (error) {
                    console.error(`Failed to create ${name} tileset:`, error);
                    reject(error);
                }
            });
        }

        // Load all available tilesets
        async function loadAllTilesets() {
            const layers = ['terrain', 'settlements', 'rivers', 'cultures', 'states'];
            const loadPromises = [];
            
            for (const layer of layers) {
                // Check if layer is available
                if (layerStatus[layer] && layerStatus[layer].status === 'completed') {
                    const url = `./tiles/${mapId}/${layer}/tileset.json`;
                    loadPromises.push(
                        loadTileset(layer, url).catch(error => {
                            console.warn(`Failed to load ${layer}:`, error);
                        })
                    );
                } else {
                    // Disable button for unavailable layers
                    const button = document.getElementById(`${layer}Btn`);
                    if (button) {
                        button.disabled = true;
                        button.textContent = `${layer} (not generated)`;
                    }
                }
            }
            
            // Wait for all tilesets to load
            await Promise.allSettled(loadPromises);
            
            // Update feature count
            let totalFeatures = 0;
            Object.values(layerStatus).forEach(layer => {
                if (layer.status === 'completed') {
                    totalFeatures += layer.file_count;
                }
            });
            document.getElementById('featureCount').textContent = totalFeatures;
        }

        // Toggle layer visibility
        function toggleLayer(layerName) {
            const tileset = tilesets[layerName];
            const button = document.getElementById(`${layerName}Btn`);
            
            if (tileset && button && !button.disabled) {
                tileset.show = !tileset.show;
                button.classList.toggle('active', tileset.show);
            }
        }

        // Show all layers
        function showAll() {
            Object.keys(tilesets).forEach(layerName => {
                const tileset = tilesets[layerName];
                const button = document.getElementById(`${layerName}Btn`);
                
                if (tileset && button && !button.disabled) {
                    tileset.show = true;
                    button.classList.add('active');
                }
            });
        }

        // Hide all layers
        function hideAll() {
            Object.keys(tilesets).forEach(layerName => {
                const tileset = tilesets[layerName];
                const button = document.getElementById(`${layerName}Btn`);
                
                if (tileset && button) {
                    tileset.show = false;
                    button.classList.remove('active');
                }
            });
        }

        // Reset camera view
        function resetView() {
            const availableTilesets = Object.values(tilesets).filter(t => t && t.ready);
            if (availableTilesets.length > 0) {
                // Zoom to the first available tileset
                viewer.zoomTo(availableTilesets[0]);
            } else {
                // Default view
                viewer.camera.setView({
                    destination: Cesium.Cartesian3.fromDegrees(0, 0, 10000)
                });
            }
        }

        // Toggle info panel
        function toggleInfo() {
            const info = document.getElementById('info');
            info.classList.toggle('hidden');
        }

        // Initialize the application
        async function initialize() {
            try {
                // Load map information
                const mapLoaded = await loadMapInfo();
                if (!mapLoaded) {
                    updateLoadingStatus('Failed to load map information');
                    return;
                }
                
                // Load tilesets
                await loadAllTilesets();
                
                // Hide loading screen and show toolbar
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('toolbar').classList.remove('hidden');
                
                // Set initial view
                setTimeout(() => {
                    resetView();
                }, 1000);
                
            } catch (error) {
                console.error('Initialization failed:', error);
                updateLoadingStatus('Failed to initialize viewer');
            }
        }

        // Start initialization
        initialize();

        // Handle keyboard shortcuts
        document.addEventListener('keydown', function(event) {
            switch(event.key) {
                case '1': toggleLayer('terrain'); break;
                case '2': toggleLayer('settlements'); break;
                case '3': toggleLayer('rivers'); break;
                case '4': toggleLayer('cultures'); break;
                case '5': toggleLayer('states'); break;
                case 'a': showAll(); break;
                case 'h': hideAll(); break;
                case 'r': resetView(); break;
                case 'i': toggleInfo(); break;
            }
        });
    </script>
</body>
</html>

